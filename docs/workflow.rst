Workflow
========

Entry point
-----------

- Snakemake entry file: ``workflow/Snakefile``
- Config: ``config/config.yaml``

Rule dependencies
-----------------

The preprocessing workflow is defined in ``workflow/rules/preprocessing.smk``.
The following DAG is derived from the declared inputs/outputs and does not
introduce any rules beyond the repository contents.

.. mermaid::

   flowchart LR
     %% Styles
     classDef raw fill:#E3F2FD,stroke:#1565C0,stroke-width:1px,color:#0D47A1
     classDef preprocess fill:#E8F5E9,stroke:#2E7D32,stroke-width:1px,color:#1B5E20
     classDef features fill:#FFF3E0,stroke:#EF6C00,stroke-width:1px,color:#E65100
     classDef model fill:#F3E5F5,stroke:#6A1B9A,stroke-width:1px,color:#4A148C
     classDef figures fill:#E0F7FA,stroke:#00838F,stroke-width:1px,color:#006064

     %% Raw data
     subgraph RAW[Raw Data]
       raw_edf[("BIDS EDF")]:::raw
       raw_channels[("BIDS channels.tsv")]:::raw
       raw_ipu[("IPU annotations CSV")]:::raw
       raw_ica[("Precomputed ICA")]:::raw
     end

     %% Preprocessing
     subgraph PRE[Preprocessing]
       downsample["downsample"]:::preprocess
       reref["reref"]:::preprocess
       ica_apply["ica_apply"]:::preprocess
       interp_rule["interpolate"]:::preprocess
       filter_raw["filter_raw"]:::preprocess
     end

     %% Feature extraction / tables
     subgraph FEAT[Feature Extraction]
       metadata_rule["metadata"]:::features
       meta_tsv["metadata.tsv"]:::features
       events_npy["events.npy"]:::features
       epoch_rule["epoch"]:::features
       epochs_out["epochs-epo.fif"]:::features
     end

     %% Modeling
     subgraph MOD[Modeling]
       model_todo{{"TODO: modeling rules"}}:::model
     end

     %% Figures
     subgraph FIG[Figures]
       fig_todo(["TODO: figure rules"]):::figures
     end

     %% Dependencies
     raw_edf --> downsample
     raw_channels --> downsample
     downsample --> reref
     raw_channels --> reref
     reref --> ica_apply
     raw_ica --> ica_apply
     ica_apply --> interp_rule
     raw_channels --> interp_rule
     interp_rule --> filter_raw
     filter_raw --> metadata_rule
     raw_ipu --> metadata_rule
     metadata_rule --> meta_tsv
     metadata_rule --> events_npy
     filter_raw --> epoch_rule
     events_npy --> epoch_rule
     meta_tsv --> epoch_rule
     epoch_rule --> epochs_out

     %% Legend
     subgraph LEG[Legend]
       l_raw[("raw data")]:::raw
       l_script["rule/script"]:::preprocess
       l_table["intermediate table"]:::features
       l_model{{"model"}}:::model
       l_fig(["figure"]):::figures
     end

Guarantees and determinism
--------------------------

- ``metadata.tsv`` is generated by aligning IPU annotations within a fixed
  temporal window; each row corresponds to one anchor IPU with partner features
  and latency.
- Outputs are deterministic given identical inputs, config, and software
  environment.
- To regenerate the full DAG, run Snakemake from the repository root with
  ``-s workflow/Snakefile`` and the desired target.
